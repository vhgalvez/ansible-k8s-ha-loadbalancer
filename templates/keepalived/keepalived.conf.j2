# templates/keepalived/keepalived.conf.j2
# ================================
# Keepalived Configuration
# Two VIPs: API (6443) and Ingress (80/443)
# ================================

global_defs {
    script_user root;
    enable_script_security;
}

vrrp_script chk_haproxy {
    script "/usr/bin/pidof haproxy";
    interval 2;
    timeout 5;
    weight -10;
    fall 2;
    rise 2;
}

vrrp_instance VI_API {
    state BACKUP;
    interface br-vip;
    virtual_router_id 51;
    priority {{ keepalived_priority_api | default(100) }};
    advert_int 1;

    authentication {
        auth_type {{ keepalived_auth_type }};
        auth_pass {{ keepalived_auth_pass }};
    }

    virtual_ipaddress {
        {{ api_vip }}/24 dev br-vip;
    }

    track_script {
        chk_haproxy;
    }

    notify_master "/etc/keepalived/scripts/vip_master.sh VI_API";
    notify_backup "/etc/keepalived/scripts/vip_backup.sh VI_API";
    notify_fault  "/etc/keepalived/scripts/vip_fault.sh VI_API";
}

vrrp_instance VI_INGRESS {
    state BACKUP;
    interface br-vip;
    virtual_router_id 52;
    priority {{ keepalived_priority_ingress | default(100) }};
    advert_int 1;

    authentication {
        auth_type {{ keepalived_auth_type }};
        auth_pass {{ keepalived_auth_pass }};
    }

    virtual_ipaddress {
        {{ second_vip }}/24 dev br-vip;
    }

    track_script {
        chk_haproxy;
    }

    notify_master "/etc/keepalived/scripts/vip_master.sh VI_INGRESS";
    notify_backup "/etc/keepalived/scripts/vip_backup.sh VI_INGRESS";
    notify_fault  "/etc/keepalived/scripts/vip_fault.sh VI_INGRESS";
}
